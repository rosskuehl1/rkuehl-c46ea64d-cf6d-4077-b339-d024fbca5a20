<div class="flex min-h-screen flex-col bg-slate-100 text-slate-900 transition-colors dark:bg-slate-950 dark:text-slate-100">
  <header class="border-b border-slate-200 bg-white/80 backdrop-blur transition-colors dark:border-slate-800 dark:bg-slate-900/80">
    <div
      class="mx-auto flex w-full max-w-6xl flex-wrap items-center justify-between gap-4 px-4 py-6 sm:flex-nowrap sm:px-6"
    >
      <div>
        <h1 class="text-2xl font-semibold text-slate-900 transition-colors dark:text-slate-100 sm:text-3xl">
          Task Management Dashboard
        </h1>
        <p class="text-sm text-slate-600 transition-colors dark:text-slate-400">
          Create, organise, and prioritise tasks for work and home.
        </p>
      </div>
      <div class="flex items-center gap-2">
        <button
          type="button"
          (click)="toggleTheme()"
          class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-slate-300 bg-white text-lg transition hover:border-emerald-400 hover:text-emerald-600 dark:border-slate-700 dark:bg-slate-900 dark:hover:border-emerald-300 dark:hover:text-emerald-200"
          [attr.aria-pressed]="theme() === 'dark'"
          [attr.title]="themeLabel()"
        >
          <span class="sr-only">Toggle theme</span>
          {{ themeIcon() }}
        </button>
        <button
          type="button"
          (click)="logout()"
          class="inline-flex items-center justify-center rounded-md border border-slate-300 px-4 py-2 text-sm font-medium text-slate-700 transition hover:border-slate-500 hover:bg-slate-100 dark:border-slate-700 dark:text-slate-100 dark:hover:border-slate-500 dark:hover:bg-slate-800"
        >
          Sign out
        </button>
      </div>
    </div>
  </header>

  <main class="mx-auto flex w-full max-w-6xl flex-1 flex-col gap-6 px-4 py-6 transition-colors sm:px-6 lg:py-8">
    <section class="grid gap-6 lg:grid-cols-[minmax(0,1fr)_22rem]">
      <div class="grid gap-6">
        <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-xl shadow-slate-200/60 transition-colors dark:border-slate-800 dark:bg-slate-900/60 dark:shadow-slate-950/40">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="flex items-center gap-2">
              <button
                type="button"
                (click)="setView('board')"
                class="view-toggle"
                [class.view-toggle-active]="viewMode() === 'board'"
                title="Board view (⇧⌘B / ⇧Ctrl+B)"
              >
                Board view
              </button>
              <button
                type="button"
                (click)="setView('list')"
                class="view-toggle"
                [class.view-toggle-active]="viewMode() === 'list'"
                title="List view (⇧⌘L / ⇧Ctrl+L)"
              >
                List view
              </button>
            </div>
            <button
              type="button"
              (click)="openCreateTask()"
              class="inline-flex items-center justify-center rounded-md bg-emerald-500 px-4 py-2 text-sm font-semibold text-emerald-950 transition hover:bg-emerald-400 dark:bg-emerald-500 dark:hover:bg-emerald-400"
              title="Add task (⇧⌘A / ⇧Ctrl+A)"
            >
              Add task
            </button>
          </div>

          <div class="mt-6 grid gap-4 md:grid-cols-2 lg:grid-cols-4">
            <label class="flex flex-col gap-2 text-sm">
              <span class="text-slate-600 transition-colors dark:text-slate-300">Search</span>
              <input
                #searchInput
                type="search"
                [value]="searchTerm()"
                (input)="updateSearch($any($event.target).value)"
                placeholder="Search tasks"
                class="input"
              />
            </label>

            <label class="flex flex-col gap-2 text-sm">
              <span class="text-slate-600 transition-colors dark:text-slate-300">Category</span>
              <select
                [value]="categoryFilter()"
                (change)="updateCategory($any($event.target).value)"
                class="input"
              >
                <option value="all">All categories</option>
                <option *ngFor="let category of categories()" [value]="category">
                  {{ category }}
                </option>
              </select>
            </label>

            <label class="flex flex-col gap-2 text-sm">
              <span class="text-slate-600 transition-colors dark:text-slate-300">Status (list view)</span>
              <select
                [value]="statusFilter()"
                (change)="updateStatus($any($event.target).value)"
                class="input"
              >
                <option value="all">All statuses</option>
                <option *ngFor="let status of statuses" [value]="status">
                  {{ status }}
                </option>
              </select>
            </label>

            <label class="flex flex-col gap-2 text-sm">
              <span class="text-slate-600 transition-colors dark:text-slate-300">Sort (list view)</span>
              <select
                [value]="sortSelection()"
                (change)="updateSort($any($event.target).value)"
                class="input"
              >
                <option *ngFor="let option of sortOptions" [value]="option.id">
                  {{ option.label }}
                </option>
              </select>
            </label>
          </div>
          <p class="mt-4 text-xs text-slate-500 transition-colors dark:text-slate-500">
            Tip: Sorting applies to the list view. Use drag-and-drop on the board to re-order priorities,
            press ⇧⌘A (⇧Ctrl+A) to create tasks, ⇧⌘S (⇧Ctrl+S) to save edits, and / to focus search.
          </p>
        </article>

        <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-xl shadow-slate-200/60 transition-colors dark:border-slate-800 dark:bg-slate-900/60 dark:shadow-slate-950/40">
          <ng-container *ngIf="statusSummary() as summary">
            <header class="flex flex-wrap items-center justify-between gap-3">
              <div>
                <h2 class="text-lg font-semibold text-slate-800 transition-colors dark:text-slate-200">
                  Task completion
                </h2>
                <p class="text-sm text-slate-500 transition-colors dark:text-slate-400">
                  Visualise how work is progressing across statuses.
                </p>
              </div>
              <div class="text-right">
                <span class="text-2xl font-semibold text-emerald-600 dark:text-emerald-300">
                  {{ summary.completionPercent }}%
                </span>
                <p class="text-xs text-slate-500 transition-colors dark:text-slate-400">
                  {{ summary.completed }}/{{ summary.total }} completed
                </p>
              </div>
            </header>

            <div class="mt-4 space-y-3" *ngIf="summary.total > 0; else emptySummary">
              <div *ngFor="let entry of summary.statusCounts" class="space-y-1">
                <div class="flex items-center justify-between text-xs uppercase tracking-wide text-slate-500 transition-colors dark:text-slate-400">
                  <span>{{ entry.status }}</span>
                  <span>{{ entry.count }}</span>
                </div>
                <div class="progress-track">
                  <div
                    class="progress-fill"
                    [style.width.%]="entry.percentage"
                    [attr.data-status]="entry.status"
                  ></div>
                </div>
              </div>
            </div>

            <ng-template #emptySummary>
              <p class="mt-2 text-xs text-slate-500 transition-colors dark:text-slate-400">
                Add a task to see completion trends.
              </p>
            </ng-template>
          </ng-container>
        </article>
      </div>

      <aside class="rounded-2xl border border-slate-200 bg-white p-4 shadow-xl shadow-slate-200/60 transition-colors dark:border-slate-800 dark:bg-slate-900/60 dark:shadow-slate-950/40">
        <h2 class="text-lg font-semibold text-slate-800 transition-colors dark:text-slate-200">Active session</h2>
  <p class="mt-1 text-sm text-slate-500 transition-colors dark:text-slate-400">
          Your token is automatically attached to outgoing API requests.
        </p>
        <article
          *ngIf="token$ | async as token; else noToken"
          class="mt-4 rounded-md border border-slate-200 bg-slate-100 p-3 text-xs text-slate-600 transition-colors dark:border-slate-800 dark:bg-slate-950/70 dark:text-slate-300"
        >
          <span class="block text-slate-500 transition-colors dark:text-slate-500">JWT</span>
          <code class="mt-2 block max-h-32 overflow-y-auto break-words">
            {{ token }}
          </code>
        </article>
        <ng-template #noToken>
          <p class="mt-4 text-xs text-slate-500 transition-colors dark:text-slate-500">
            No active token detected. Sign in to resume your session.
          </p>
        </ng-template>
      </aside>
    </section>

    <section *ngIf="isTaskFormOpen()" class="rounded-2xl border border-slate-200 bg-white/95 p-6 shadow-xl shadow-slate-200/60 transition-colors dark:border-slate-800 dark:bg-slate-900/80 dark:shadow-slate-950/40">
      <form class="grid gap-4" [formGroup]="taskForm" (ngSubmit)="saveTask()">
        <header class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h2 class="text-xl font-semibold text-slate-800 transition-colors dark:text-slate-100">
              {{ editingTask() ? 'Edit task' : 'Create task' }}
            </h2>
            <p class="text-sm text-slate-500 transition-colors dark:text-slate-400">
              Capture the key details to keep the team on track.
            </p>
          </div>
          <div class="flex gap-2">
            <button type="button" class="ghost-button" (click)="closeTaskForm()">
              Cancel
            </button>
            <button type="submit" class="primary-button">
              {{ editingTask() ? 'Save changes' : 'Create task' }}
            </button>
          </div>
        </header>

        <label class="flex flex-col gap-2 text-sm">
          <span class="text-slate-600 transition-colors dark:text-slate-300">Title</span>
          <input
            type="text"
            formControlName="title"
            placeholder="Task title"
            class="input"
            required
          />
        </label>

        <label class="flex flex-col gap-2 text-sm">
          <span class="text-slate-600 transition-colors dark:text-slate-300">Description</span>
          <textarea
            rows="3"
            formControlName="description"
            placeholder="Add context or acceptance criteria"
            class="input"
          ></textarea>
        </label>

        <div class="grid gap-4 md:grid-cols-3">
          <label class="flex flex-col gap-2 text-sm">
            <span class="text-slate-600 transition-colors dark:text-slate-300">Category</span>
            <input
              type="text"
              formControlName="category"
              placeholder="e.g. Work, Personal"
              class="input"
              required
            />
          </label>

          <label class="flex flex-col gap-2 text-sm">
            <span class="text-slate-600 transition-colors dark:text-slate-300">Status</span>
            <select formControlName="status" class="input">
              <option *ngFor="let status of statuses" [value]="status">
                {{ status }}
              </option>
            </select>
          </label>

          <label class="flex flex-col gap-2 text-sm">
            <span class="text-slate-600 transition-colors dark:text-slate-300">Due date</span>
            <input type="date" formControlName="dueDate" class="input" />
          </label>
        </div>
      </form>
    </section>

    <section
      *ngIf="viewMode() === 'board'; else listView"
      class="grid gap-4 lg:grid-cols-3"
    >
      <article
        *ngFor="let column of boardColumns(); trackBy: trackByStatus"
        class="flex min-h-[18rem] flex-col rounded-2xl border border-slate-200 bg-white shadow-lg shadow-slate-200/60 transition-colors dark:border-slate-800 dark:bg-slate-900/70 dark:shadow-slate-950/30"
      >
        <header class="flex items-center justify-between border-b border-slate-200 px-4 py-4 transition-colors dark:border-slate-800">
          <h3 class="text-lg font-semibold text-slate-800 transition-colors dark:text-slate-200">{{ column.status }}</h3>
          <span class="rounded-full bg-slate-100 px-2 py-0.5 text-xs text-slate-600 transition-colors dark:bg-slate-800 dark:text-slate-300">
            {{ column.tasks.length }}
          </span>
        </header>

        <div
          class="flex flex-1 flex-col gap-3 p-4"
          (dragover)="allowDrop($event)"
          (drop)="onColumnDrop(column.status, $event)"
        >
          <ng-container *ngIf="column.tasks.length > 0; else emptyColumn">
            <ng-container *ngFor="let task of column.tasks; let i = index; trackBy: trackByTaskId">
              <div
                class="drop-target"
                [class.is-active]="draggingTaskId()"
                (dragover)="allowDrop($event)"
                (drop)="onTaskDrop(column.status, i, $event)"
              ></div>

              <article
                draggable="true"
                (dragstart)="onDragStart(task, $event)"
                (dragend)="onDragEnd()"
                class="group rounded-xl border border-slate-200 bg-white p-4 shadow-md shadow-slate-200/60 transition hover:border-emerald-400 dark:border-slate-800 dark:bg-slate-950/80 dark:shadow-slate-950/40 dark:hover:border-emerald-500/70"
              >
                <div class="flex items-start justify-between gap-3">
                  <div class="space-y-2">
                    <h4 class="text-base font-semibold text-slate-800 transition-colors dark:text-slate-100">{{ task.title }}</h4>
                    <p *ngIf="task.description" class="text-sm text-slate-600 transition-colors dark:text-slate-400">
                      {{ task.description }}
                    </p>
                  </div>
                  <button type="button" class="ghost-button ghost-button-sm" (click)="openEditTask(task)">
                    Edit
                  </button>
                </div>

                <div class="mt-4 flex flex-wrap items-center gap-2 text-xs text-slate-500 transition-colors dark:text-slate-400">
                  <span class="rounded-full bg-slate-100 px-2.5 py-1 text-slate-600 transition-colors dark:bg-slate-800 dark:text-slate-200">
                    {{ task.category }}
                  </span>
                  <span *ngIf="task.dueDate" class="rounded-full bg-amber-100 px-2.5 py-1 text-amber-700 transition-colors dark:bg-amber-500/20 dark:text-amber-300">
                    Due {{ task.dueDate | date: 'mediumDate' }}
                  </span>
                  <span class="hidden text-slate-400 transition-colors dark:text-slate-500 sm:inline">•</span>
                  <button type="button" class="text-rose-600 transition hover:text-rose-500 dark:text-rose-300 dark:hover:text-rose-200" (click)="deleteTask(task)">
                    Delete
                  </button>
                </div>
              </article>
            </ng-container>

            <div
              class="drop-target"
              [class.is-active]="draggingTaskId()"
              (dragover)="allowDrop($event)"
              (drop)="onTaskDrop(column.status, column.tasks.length, $event)"
            ></div>
          </ng-container>
          <ng-template #emptyColumn>
            <div
              class="empty-drop-zone"
              [class.is-active]="draggingTaskId()"
              (dragover)="allowDrop($event)"
              (drop)="onTaskDrop(column.status, 0, $event)"
            >
              Drop tasks here to get started.
            </div>
          </ng-template>
        </div>
      </article>
    </section>

    <ng-template #listView>
      <section class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-lg shadow-slate-200/60 transition-colors dark:border-slate-800 dark:bg-slate-900/70 dark:shadow-slate-950/30">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200 text-sm transition-colors dark:divide-slate-800">
            <thead class="bg-slate-50 text-left text-xs uppercase tracking-wide text-slate-500 transition-colors dark:bg-slate-900/80 dark:text-slate-400">
              <tr>
                <th scope="col" class="px-4 py-3">Title</th>
                <th scope="col" class="px-4 py-3">Category</th>
                <th scope="col" class="px-4 py-3">Status</th>
                <th scope="col" class="px-4 py-3">Due</th>
                <th scope="col" class="px-4 py-3">Updated</th>
                <th scope="col" class="px-4 py-3 text-right">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-200 transition-colors dark:divide-slate-800">
              <tr *ngIf="listTasks().length === 0">
                <td colspan="6" class="px-4 py-6 text-center text-slate-500 transition-colors dark:text-slate-400">
                  No tasks match the current filters. Try adjusting the search or
                  category.
                </td>
              </tr>
              <tr *ngFor="let task of listTasks(); trackBy: trackByTaskId" class="hover:bg-slate-50 transition-colors dark:hover:bg-slate-900/60">
                <td class="max-w-[18rem] truncate px-4 py-3 font-medium text-slate-800 transition-colors dark:text-slate-100">
                  {{ task.title }}
                </td>
                <td class="px-4 py-3 text-slate-600 transition-colors dark:text-slate-300">{{ task.category }}</td>
                <td class="px-4 py-3 text-slate-600 transition-colors dark:text-slate-300">{{ task.status }}</td>
                <td class="px-4 py-3 text-slate-600 transition-colors dark:text-slate-300">
                  {{ task.dueDate ? (task.dueDate | date: 'mediumDate') : '—' }}
                </td>
                <td class="px-4 py-3 text-slate-600 transition-colors dark:text-slate-300">
                  {{ task.updatedAt | date: 'short' }}
                </td>
                <td class="px-4 py-3">
                  <div class="flex justify-end gap-2">
                    <button type="button" class="ghost-button ghost-button-sm" (click)="openEditTask(task)">
                      Edit
                    </button>
                    <button type="button" class="text-rose-600 transition hover:text-rose-500 dark:text-rose-300 dark:hover:text-rose-200" (click)="deleteTask(task)">
                      Delete
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </ng-template>
  </main>
</div>
